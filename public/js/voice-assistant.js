(function(){var container=document.getElementById('voice-assistant');if(!container)return;var routes={};try{routes=JSON.parse(container.getAttribute('data-routes')||'{}')}catch(e){routes={}}
var panel=container.querySelector('.va-panel');var fab=container.querySelector('.va-fab');var closeBtn=container.querySelector('.va-close');var messages=container.querySelector('.va-messages');var micBtn=container.querySelector('.va-mic');var sendBtn=container.querySelector('.va-send');var input=container.querySelector('.va-text');var speakToggle=container.querySelector('.va-speak-toggle');var helpBtn=container.querySelector('.va-help');var guideBtn=container.querySelector('.va-guide');var quickBtns=container.querySelectorAll('[data-quick]');var onboarding=document.getElementById('va-onboarding');var ONBOARDING_SEEN_KEY='va_onboarding_seen_v1';var voiceEnabled=!0;var listening=!1;var pendingAction=null;var isSpeaking=!1;var speakMuteUntil=0;var lastSpokenText='';var lastSpokenAt=0;var lastHandledTranscript='';var lastHandledAt=0;var LISTEN_CONTINUOUS_KEY='va_listen_continuous_v2';var LEGACY_LISTEN_KEY='va_listen_continuous';var VOICE_ENABLED_KEY='va_voice_enabled_v1';var GUIDE_DONE_MESSAGE=container.getAttribute('data-guide-complete')||'Guide complete. Say your command or type it below.';var WELCOME_MESSAGE=container.getAttribute('data-welcome-message')||'Hi! Tell me what you want to do. I can open pages, help with checkout, or fill forms.';var HELP_MESSAGE=container.getAttribute('data-help-message')||'Try: \"open pricing\", \"go to packages\", \"download opplex app\", \"checkout\", \"contact support\", or \"my email is ...\".';var VOICE_ON_TEXT=container.getAttribute('data-voice-on')||'Voice On';var VOICE_OFF_TEXT=container.getAttribute('data-voice-off')||'Voice Off';var ACTIVE_LOCALE=String(container.getAttribute('data-locale')||document.documentElement.lang||'en').toLowerCase();var LOCALE_BASE=ACTIVE_LOCALE.split('-')[0];var memory={fullName:'',firstName:'',lastName:'',email:'',phone:'',message:'',notes:''};function addMessage(role,text){var item=document.createElement('div');item.className='va-msg va-'+role;item.textContent=text;messages.appendChild(item);messages.scrollTop=messages.scrollHeight;if(role==='assistant'&&voiceEnabled)speak(text);}
function speak(text){if(!('speechSynthesis' in window))return;try{var now=Date.now();var t=String(text||'').trim();if(!t)return;if(t===lastSpokenText&&(now-lastSpokenAt)<4000)return;lastSpokenText=t;lastSpokenAt=now;window.speechSynthesis.cancel();var utter=new SpeechSynthesisUtterance(t);utter.onstart=function(){isSpeaking=!0};utter.onend=function(){isSpeaking=!1;speakMuteUntil=Date.now()+1200};utter.onerror=function(){isSpeaking=!1;speakMuteUntil=Date.now()+1200};window.speechSynthesis.speak(utter)}catch(e){}}
function openPanel(){panel.classList.add('open');document.body.classList.add('va-panel-open')}
function closePanel(){panel.classList.remove('open');document.body.classList.remove('va-panel-open')}
function setOnboardingSeen(){try{localStorage.setItem(ONBOARDING_SEEN_KEY,'1')}catch(e){}}
function isOnboardingSeen(){try{return localStorage.getItem(ONBOARDING_SEEN_KEY)==='1'}catch(e){return!1}}
function initOnboardingGuide(){if(!onboarding)return;var steps=Array.prototype.slice.call(onboarding.querySelectorAll('.va-step'));var prevBtn=onboarding.querySelector('[data-prev]');var nextBtn=onboarding.querySelector('[data-next]');var skipBtn=onboarding.querySelector('[data-skip]');var closeEls=onboarding.querySelectorAll('[data-close]');var locale=String(container.getAttribute('data-locale')||'en').toLowerCase();var localeBase=locale.split('-')[0];var doneByLocale={en:'Done',ur:'مکمل',ar:'تم',es:'Listo',fr:'Terminé',hi:'पूरा',it:'Fatto',nl:'Klaar',pt:'Concluir',ru:'Готово'};var nextLabel=nextBtn?(nextBtn.getAttribute('data-next-text')||nextBtn.textContent||'Next'):'Next';var doneRaw=nextBtn?(nextBtn.getAttribute('data-done-text')||''):'';var doneLabel=doneRaw;if(!doneLabel||doneLabel==='Done'||doneLabel==='messages.voice_guide.done'){doneLabel=doneByLocale[locale]||doneByLocale[localeBase]||'Done'}
var stepIndex=0;function renderStep(){if(!steps.length)return;if(stepIndex<0)stepIndex=0;if(stepIndex>steps.length-1)stepIndex=steps.length-1;steps.forEach(function(s,i){s.classList.toggle('active',i===stepIndex)});if(prevBtn)prevBtn.disabled=stepIndex===0;if(nextBtn)nextBtn.textContent=stepIndex===steps.length-1?doneLabel:nextLabel}
function openGuide(markSeen){if(markSeen)setOnboardingSeen();onboarding.classList.add('open');onboarding.setAttribute('aria-hidden','false');stepIndex=0;renderStep()}
function closeGuide(markSeen){if(markSeen)setOnboardingSeen();onboarding.classList.remove('open');onboarding.setAttribute('aria-hidden','true')}
if(prevBtn){prevBtn.addEventListener('click',function(){stepIndex-=1;renderStep()})}
if(nextBtn){nextBtn.addEventListener('click',function(){if(stepIndex>=steps.length-1){closeGuide(!0);openPanel();if(!messages.hasChildNodes()){addMessage('assistant',GUIDE_DONE_MESSAGE)}
return}
stepIndex+=1;renderStep()})}
if(skipBtn){skipBtn.addEventListener('click',function(){closeGuide(!0)})}
closeEls.forEach(function(el){el.addEventListener('click',function(){closeGuide(!0)})});document.addEventListener('keydown',function(e){if(e.key==='Escape'&&onboarding.classList.contains('open')){closeGuide(!0)}});if(guideBtn){guideBtn.addEventListener('click',function(){openGuide(!1)})}
if(!isOnboardingSeen()){setTimeout(function(){openGuide(!0)},900)}}
function isCheckoutCompletePage(){var path=(window.location.pathname||'').toLowerCase();if(path.indexOf('thank-you')!==-1||path.indexOf('thankyou')!==-1)return!0;return!!document.querySelector('.thank-wrap, .thank-card')}
function setContinuousListening(enabled){try{if(enabled)sessionStorage.setItem(LISTEN_CONTINUOUS_KEY,'1');else sessionStorage.removeItem(LISTEN_CONTINUOUS_KEY)}catch(e){}}
function setVoiceEnabledState(enabled){try{localStorage.setItem(VOICE_ENABLED_KEY,enabled?'1':'0')}catch(e){}}
function getVoiceEnabledState(){try{var raw=localStorage.getItem(VOICE_ENABLED_KEY);if(raw==='0')return!1;if(raw==='1')return!0}catch(e){}
return!0}
function isContinuousListeningEnabled(){try{return sessionStorage.getItem(LISTEN_CONTINUOUS_KEY)==='1'}catch(e){return!1}}
fab.addEventListener('click',function(){openPanel();if(!messages.hasChildNodes()){addMessage('assistant',WELCOME_MESSAGE)}});closeBtn.addEventListener('click',closePanel);speakToggle.addEventListener('click',function(){voiceEnabled=!voiceEnabled;setVoiceEnabledState(voiceEnabled);speakToggle.setAttribute('aria-pressed',voiceEnabled?'true':'false');speakToggle.textContent=voiceEnabled?VOICE_ON_TEXT:VOICE_OFF_TEXT;if(!voiceEnabled){try{window.speechSynthesis&&window.speechSynthesis.cancel()}catch(e){}}});helpBtn.addEventListener('click',function(){addMessage('assistant',HELP_MESSAGE)});quickBtns.forEach(function(btn){btn.addEventListener('click',function(){var key=btn.getAttribute('data-quick');handleIntent('open '+key)})});function setFieldValue(name,value){var field=document.querySelector('[name="'+name+'"]');if(!field)return!1;field.value=value;field.dispatchEvent(new Event('input',{bubbles:!0}));field.dispatchEvent(new Event('change',{bubbles:!0}));return!0}
function fillContactForm(){var did=!1;if(memory.fullName)did=setFieldValue('username',memory.fullName)||did;if(memory.email)did=setFieldValue('email',memory.email)||did;if(memory.phone)did=setFieldValue('phone',memory.phone)||did;if(memory.message)did=setFieldValue('message',memory.message)||did;return did}
function fillCheckoutForm(){var did=!1;if(memory.email)did=setFieldValue('email',memory.email)||did;if(memory.firstName)did=setFieldValue('first_name',memory.firstName)||did;if(memory.lastName)did=setFieldValue('last_name',memory.lastName)||did;if(memory.phone)did=setFieldValue('phone',memory.phone)||did;if(memory.notes)did=setFieldValue('notes',memory.notes)||did;return did}
function parseName(text){var parts=text.trim().split(/\s+/);if(parts.length===1)return{first:parts[0],last:''};return{first:parts[0],last:parts.slice(1).join(' ')}}
function openRoute(key,label){var url=routes[key];if(!url){addMessage('assistant','I cannot find that page right now.');return}
addMessage('assistant','Opening '+(label||key)+'...');window.location.href=url}
function normalizeText(text){return(text||'').toLowerCase().normalize('NFKC').replace(/[^\p{L}\p{N}\s]/gu,' ').replace(/\s+/g,' ').trim()}
function normalizeIntentLower(lowerInput){var s=String(lowerInput||'').toLowerCase();s=s.replace(/\b(please|kindly|just|bro|buddy|hey|yo)\b/g,' ');s=s.replace(/\b(take me to|navigate to|go to|go on|bring me to|show me|open up)\b/g,' open ');s=s.replace(/\b(purchase|order now|book now|get me|i want to buy|i wanna buy|buy it now)\b/g,' buy ');s=s.replace(/\b(check out|checkout now|complete order|complete checkout|finish checkout)\b/g,' checkout ');s=s.replace(/\b(dismiss|hide this|shut this|close this window|x out|exit popup|close pop up)\b/g,' close ');s=s.replace(/\bstar[\s-]?share\b/g,' starshare ');s=s.replace(/\b(12 months?|12 month|one year|1 year|annual|year plan)\b/g,' yearly ');s=s.replace(/\b(6 months?|6 month|six months?|half year|semi annual|semi-annual)\b/g,' half yearly ');s=s.replace(/\b(3 months?|3 month|three months?|quarterly|quarter plan)\b/g,' 3 months ');s=s.replace(/\b(1 month|one month|per month|month plan)\b/g,' monthly ');s=s.replace(/\bat the rate\b/g,' at ');s=s.replace(/\bat[-\s]?rate\b/g,' at ');return s.replace(/\s+/g,' ').trim()}
function canonicalizeMultilingualInput(text){var s=String(text||'').normalize('NFKC');if(!s)return s;function apply(words,token){if(!words||!words.length)return;var escaped=words.map(function(w){return String(w).replace(/[.*+?^${}()|[\]\\]/g,'\\$&')});var rx=new RegExp('(?:^|\\s)('+escaped.join('|')+')(?=$|\\s)','giu');s=s.replace(rx,' '+token+' ')}
var byLocale={ar:{open:['\u0627\u0641\u062a\u062d','\u0627\u0641\u062a\u062d \u0627\u0644\u0635\u0641\u062d\u0629','\u0627\u0630\u0647\u0628','\u0627\u0630\u0647\u0628 \u0625\u0644\u0649','\u0627\u0646\u062a\u0642\u0644','\u0627\u0639\u0631\u0636','\u0623\u0638\u0647\u0631'],pricing:['\u0627\u0644\u0627\u0633\u0639\u0627\u0631','\u0627\u0644\u0623\u0633\u0639\u0627\u0631','\u0627\u0644\u0633\u0639\u0631','\u0627\u0644\u0623\u0633\u0639\u0627\u0631 \u0648\u0627\u0644\u0628\u0627\u0642\u0627\u062a','\u0627\u0644\u062a\u0633\u0639\u064a\u0631'],packages:['\u0627\u0644\u0628\u0627\u0642\u0627\u062a','\u0628\u0627\u0642\u0629','\u0627\u0644\u0628\u0627\u0642\u0629','\u062d\u0632\u0645','\u0627\u0634\u062a\u0631\u0627\u0643'],checkout:['\u0627\u0644\u062f\u0641\u0639','\u0627\u0644\u062f\u0641\u0639 \u0627\u0644\u0622\u0646','\u0634\u0631\u0627\u0621','\u0627\u0634\u062a\u0631','\u0623\u0637\u0644\u0628','\u062a\u0623\u0643\u064a\u062f \u0627\u0644\u0637\u0644\u0628','\u0623\u0643\u0645\u0644 \u0627\u0644\u062f\u0641\u0639'],contact:['\u0627\u062a\u0635\u0644','\u062a\u0648\u0627\u0635\u0644','\u062f\u0639\u0645','\u062e\u062f\u0645\u0629 \u0627\u0644\u0639\u0645\u0644\u0627\u0621','\u0627\u0644\u0645\u0633\u0627\u0639\u062f\u0629'],close:['\u0627\u063a\u0644\u0642','\u0625\u063a\u0644\u0627\u0642','\u0633\u0643\u0631','\u0627\u063a\u0644\u0642 \u0647\u0630\u0627'],search:['\u0627\u0628\u062d\u062b','\u0628\u062d\u062b','\u0627\u0628\u062d\u062b \u0639\u0646','\u0628\u062d\u062b \u0639\u0646']},ur:{open:['\u06a9\u06be\u0648\u0644\u0648','\u06a9\u06be\u0648\u0644','\u062f\u06a9\u06be\u0627\u0624','\u062f\u06a9\u06be\u0627\u0624','\u062c\u0627\u0624','\u062c\u0627\u0648','khol','kholo','open karo','dikhao'],pricing:['\u0642\u06cc\u0645\u062a','\u067e\u0631\u0627\u0626\u0633','\u067e\u0631\u0627\u0626\u0633\u0646\u06af','pricing','price','rates'],packages:['\u067e\u06cc\u06a9\u06cc\u062c','\u067e\u06cc\u06a9\u06cc\u062c\u0632','\u067e\u0644\u0627\u0646','\u067e\u0644\u0627\u0646\u0632','packages','plans','subscription'],checkout:['\u0686\u06cc\u06a9 \u0622\u0624\u0679','\u0686\u06cc\u06a9\u0622\u0624\u0679','\u0627\u062f\u0627\u0626\u06cc\u06af\u06cc','\u067e\u06cc\u0645\u0646\u0679','\u0622\u0631\u0688\u0631','checkout','payment','pay','order','place order'],contact:['\u0631\u0627\u0628\u0637\u06c1','\u0633\u067e\u0648\u0631\u0679','\u0645\u062f\u062f','contact','support','help'],close:['\u0628\u0646\u062f','\u0628\u0646\u062f \u06a9\u0631\u0648','close'],search:['\u062a\u0644\u0627\u0634','\u0688\u06be\u0648\u0646\u0688\u0648','search','find']},es:{open:['abrir','mostrar','ir','ir a'],pricing:['precio','precios'],packages:['paquete','paquetes','planes'],checkout:['pago','comprar','pedido','checkout'],contact:['contacto','soporte','ayuda'],close:['cerrar'],search:['buscar','busqueda','b?squeda']},fr:{open:['ouvrir','afficher','aller','aller a','aller ?'],pricing:['prix','tarif','tarifs'],packages:['forfait','forfaits','package','packages'],checkout:['paiement','acheter','commande','checkout'],contact:['contact','support','aide'],close:['fermer'],search:['chercher','rechercher']},hi:{open:['\u0916\u094b\u0932\u094b','\u0916\u094b\u0932\u0947\u0902','\u0926\u093f\u0916\u093e\u0913','\u0926\u093f\u0916\u093e\u090f\u0902','\u091c\u093e\u0913','\u091c\u093e\u090f\u0902'],pricing:['\u0915\u0940\u092e\u0924','\u0926\u093e\u092e','\u092a\u094d\u0930\u093e\u0907\u0938','\u092a\u094d\u0930\u093e\u0907\u0938\u093f\u0902\u0917'],packages:['\u092a\u0948\u0915\u0947\u091c','\u092a\u0948\u0915\u0947\u091c\u0938','\u092a\u094d\u0932\u093e\u0928','\u092a\u094d\u0932\u093e\u0928\u094d\u0938','\u0938\u092c\u094d\u0938\u0915\u094d\u0930\u093f\u092a\u094d\u0936\u0928'],checkout:['\u091a\u0947\u0915\u0906\u0909\u091f','\u092a\u0947\u092e\u0947\u0902\u091f','\u0911\u0930\u094d\u0921\u0930','\u0916\u0930\u0940\u0926\u094b','\u0905\u092d\u0940 \u0916\u0930\u0940\u0926\u0947\u0902','\u092d\u0941\u0917\u0924\u093e\u0928'],contact:['\u0938\u0902\u092a\u0930\u094d\u0915','\u0938\u092a\u094b\u0930\u094d\u091f','\u092e\u0926\u0926','\u0938\u0939\u093e\u092f\u0924\u093e'],close:['\u092c\u0902\u0926','\u092c\u0902\u0926 \u0915\u0930\u094b','\u0915\u094d\u0932\u094b\u091c'],search:['\u0916\u094b\u091c\u094b','\u0924\u0932\u093e\u0936','\u0938\u0930\u094d\u091a']},it:{open:['apri','mostra','vai','vai a'],pricing:['prezzo','prezzi'],packages:['pacchetto','pacchetti','piani'],checkout:['pagamento','compra','ordine','checkout'],contact:['contatto','supporto','aiuto'],close:['chiudi'],search:['cerca','ricerca']},nl:{open:['open','openen','toon','ga','ga naar','laat zien','naar'],pricing:['prijs','prijzen','tarief','tarieven'],packages:['pakket','pakketten','plan','plannen','abonnement','abonnementen'],checkout:['afrekenen','betaling','bestellen','koop','bestel','nu kopen'],contact:['contact','ondersteuning','support','hulp','klantenservice'],close:['sluiten','dicht','sluit'],search:['zoeken','zoek','opzoeken']},pt:{open:['abrir','mostrar','ir','ir para','abrir página','abrir pagina'],pricing:['preco','preço','precos','preços','valor','valores'],packages:['pacote','pacotes','plano','planos','assinatura','assinaturas'],checkout:['pagamento','comprar','pedido','checkout','finalizar compra','pagar agora'],contact:['contato','suporte','ajuda','falar com suporte','atendimento'],close:['fechar','encerrar'],search:['buscar','pesquisar','procurar']},ru:{open:['\u043e\u0442\u043a\u0440\u044b\u0442\u044c','\u043f\u043e\u043a\u0430\u0437\u0430\u0442\u044c','\u043f\u0435\u0440\u0435\u0439\u0442\u0438','\u043f\u0435\u0440\u0435\u0439\u0442\u0438 \u043d\u0430'],pricing:['\u0446\u0435\u043d\u0430','\u0446\u0435\u043d\u044b','\u043f\u0440\u0430\u0439\u0441','\u0442\u0430\u0440\u0438\u0444'],packages:['\u043f\u0430\u043a\u0435\u0442','\u043f\u0430\u043a\u0435\u0442\u044b','\u043f\u043b\u0430\u043d','\u043f\u043b\u0430\u043d\u044b','\u043f\u043e\u0434\u043f\u0438\u0441\u043a\u0430'],checkout:['\u043e\u043f\u043b\u0430\u0442\u0430','\u043a\u0443\u043f\u0438\u0442\u044c','\u0437\u0430\u043a\u0430\u0437','\u0447\u0435\u043a\u0430\u0443\u0442','\u043e\u0444\u043e\u0440\u043c\u0438\u0442\u044c \u0437\u0430\u043a\u0430\u0437'],contact:['\u043a\u043e\u043d\u0442\u0430\u043a\u0442','\u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0430','\u043f\u043e\u043c\u043e\u0449\u044c','\u0441\u0432\u044f\u0437\u0430\u0442\u044c\u0441\u044f'],close:['\u0437\u0430\u043a\u0440\u044b\u0442\u044c','\u0437\u0430\u043a\u0440\u043e\u0439'],search:['\u043f\u043e\u0438\u0441\u043a','\u0438\u0441\u043a\u0430\u0442\u044c','\u043d\u0430\u0439\u0442\u0438']}};var d=byLocale[LOCALE_BASE];if(d){apply(d.open,'open');apply(d.pricing,'pricing');apply(d.packages,'packages');apply(d.checkout,'checkout');apply(d.contact,'contact');apply(d.close,'close');apply(d.search,'search')}
return s.replace(/\s+/g,' ').trim()}
function isDownloadAnchor(anchor){if(!anchor||!anchor.href)return!1;var text=normalizeText(anchor.textContent||'');var label=normalizeText(anchor.getAttribute('aria-label')||'');var keywords=normalizeText(anchor.getAttribute('data-keywords')||'');var href=(anchor.getAttribute('href')||'').toLowerCase();if(text.indexOf('download')!==-1)return!0;if(label.indexOf('download')!==-1)return!0;if(keywords.length>0)return!0;if(href.indexOf('/redirect')!==-1)return!0;if(href.indexOf('/downloads/')!==-1)return!0;return!1}
function downloadLinkText(anchor){var text=normalizeText(anchor.textContent||'');var label=normalizeText(anchor.getAttribute('aria-label')||'');var keywords=normalizeText(anchor.getAttribute('data-keywords')||'');return(text+' '+label+' '+keywords).trim()}
function findBestDownloadLink(query){var stopWords={download:!0,app:!0,apk:!0,please:!0,for:!0,iptv:!0,player:!0,open:!0,install:!0,get:!0,karo:!0,krdo:!0,kar:!0,do:!0,mujhe:!0,chahiye:!0};var cleanQuery=normalizeText(query);var tokens=cleanQuery.split(' ').filter(function(t){return t.length>1&&!stopWords[t]});if(!tokens.length)return null;var links=Array.prototype.slice.call(document.querySelectorAll('a[href]')).filter(isDownloadAnchor);var best=null;var bestScore=0;links.forEach(function(anchor){var hay=downloadLinkText(anchor);var score=0;tokens.forEach(function(token){if(hay.indexOf(token)!==-1)score+=3});if(cleanQuery.length>2&&hay.indexOf(cleanQuery)!==-1)score+=5;if(score>bestScore){best=anchor;bestScore=score}});return bestScore>0?best:null}
function triggerDownload(anchor){var title=(anchor.textContent||'that app').replace(/\s+/g,' ').trim();addMessage('assistant','Starting download: '+title);var target=anchor.getAttribute('target')||'_self';if(target==='_blank'){window.open(anchor.href,'_blank','noopener');return}
window.location.href=anchor.href}
function requestDownloadOnAppsPage(query){try{localStorage.setItem('va_pending_download_query',query)}catch(e){}
openRoute('apps','IPTV applications')}
function requestPricingActionOnPricingPage(command){try{localStorage.setItem('va_pending_pricing_command',command)}catch(e){}
openRoute('pricing','pricing')}
function requestShopActionOnShopPage(command){try{localStorage.setItem('va_pending_shop_command',command)}catch(e){}
openRoute('shop','shop')}
function requestMoviesSearchOnMoviesPage(command){try{localStorage.setItem('va_pending_movies_search',command)}catch(e){}
openRoute('movies','movies')}
function tryPendingDownload(){var pending='';try{pending=localStorage.getItem('va_pending_download_query')||''}catch(e){}
if(!pending)return;try{localStorage.removeItem('va_pending_download_query')}catch(e){}
var found=findBestDownloadLink(pending);if(found){setTimeout(function(){addMessage('assistant','Matched app "'+pending+'".');triggerDownload(found)},400)}else{addMessage('assistant','I opened apps page. Please say the app name again, like "download opplex app".')}}
function tryPendingPricingAction(){var pending='';try{pending=localStorage.getItem('va_pending_pricing_command')||''}catch(e){}
if(!pending)return;try{localStorage.removeItem('va_pending_pricing_command')}catch(e){}
setTimeout(function(){var ok=handlePricingSectionIntent(pending,pending.toLowerCase());if(!ok){addMessage('assistant','Pricing page opened. Please repeat package command, e.g. "buy yearly".')}},500)}
function tryPendingShopAction(){var pending='';try{pending=localStorage.getItem('va_pending_shop_command')||''}catch(e){}
if(!pending)return;try{localStorage.removeItem('va_pending_shop_command')}catch(e){}
setTimeout(function(){var ok=handleShopBuyIntent(pending,pending.toLowerCase());if(!ok){addMessage('assistant','Shop page opened. Please repeat product hint, e.g. "buy roku 4k on amazon".')}},500)}
function hasMoviesSearchSection(){return!!document.querySelector('form[aria-label="Search Movies and Series"] input[name="search"]')}
function extractMoviesSearchQuery(raw,lower){var q=String(raw||'');q=q.replace(/^\s*(search|find|look up|lookup)\s*/i,'');q=q.replace(/\s*(in\s+movies|movies|movie|series|cartoons)\s*$/i,'');q=q.replace(/\s+/g,' ').trim();if(!q){var n=normalizeText(lower||'');var m=n.match(/(?:search|find|look up|lookup)\s+(.+)/);if(m&&m[1])q=m[1].trim();}
return q}
function runMoviesSearch(query){if(!hasMoviesSearchSection())return!1;var form=document.querySelector('form[aria-label="Search Movies and Series"]');var input=form?form.querySelector('input[name="search"]'):null;if(!form||!input)return!1;var q=String(query||'').trim();if(!q)return!1;input.value=q;input.dispatchEvent(new Event('input',{bubbles:!0}));input.dispatchEvent(new Event('change',{bubbles:!0}));if(typeof form.requestSubmit==='function')form.requestSubmit();else form.submit();addMessage('assistant','Searching movies for: '+q);return!0}
function handleMoviesSearchIntent(raw,lower){var hasIntent=/\bsearch\b|\bfind\b|\blook up\b|\blookup\b/.test(lower);var hasMoviesContext=/\bmovie\b|\bmovies\b|\bseries\b|\bcartoons\b/.test(lower);if(!hasIntent&&!hasMoviesContext)return!1;var query=extractMoviesSearchQuery(raw,lower);if(!query||query.length<2)return!1;if(hasMoviesSearchSection()){return runMoviesSearch(query)}
requestMoviesSearchOnMoviesPage(raw);return!0}
function hasMoviesGrid(){return!!document.querySelector('.filter-list .feature-block.style-two')}
function normalizeMovieQuery(raw){return normalizeText(raw||'').replace(/\b(open|play|watch|start|show|close)\b/g,' ').replace(/\b(trailer|video|movie|series|cartoon)\b/g,' ').replace(/\s+/g,' ').trim()}
function findMovieCardByName(query){if(!hasMoviesGrid())return null;var cards=Array.prototype.slice.call(document.querySelectorAll('.filter-list .feature-block.style-two'));if(!cards.length)return null;var q=normalizeText(query||'');if(!q)return null;var tokens=q.split(' ').filter(function(t){return t.length>1});if(!tokens.length)return null;var best=null;var bestScore=0;cards.forEach(function(card){var titleEl=card.querySelector('.lower-content h6 a');var title=normalizeText(titleEl?titleEl.textContent:'');if(!title)return;var score=0;if(title===q)score+=20;if(title.indexOf(q)!==-1||q.indexOf(title)!==-1)score+=10;tokens.forEach(function(t){if(title.indexOf(t)!==-1)score+=2});if(score>bestScore){best=card;bestScore=score}});return bestScore>=4?best:null}
function handleOpenTrailerByName(raw,lower){var intent=/\b(open|play|watch|start|show)\b.*\b(trailer|video)\b|\btrailer\b.*\b(open|play|watch)\b/.test(lower);if(!intent)return!1;if(!hasMoviesGrid())return!1;var query=normalizeMovieQuery(raw);var card=findMovieCardByName(query);if(!card){addMessage('assistant','Movie naam clear nahi mila. Example: "open trailer marty supreme".');return!0}
var playLink=card.querySelector('a.lightbox-image.video-box');if(!playLink){addMessage('assistant','Is movie ka trailer link available nahi hai.');return!0}
card.scrollIntoView({behavior:'smooth',block:'center'});playLink.click();addMessage('assistant','Opening trailer.');return!0}
function closeOpenOverlays(){var selectors=['.fancybox-button--close','.fancybox-close-small','.fancybox-close','.mfp-close','.modal.show .btn-close','.modal.show [data-dismiss="modal"]','.lightbox .close','.video-modal .close'];var clicked=!1;selectors.forEach(function(sel){var btn=document.querySelector(sel);if(btn&&isElementVisible(btn)){btn.click();clicked=!0}});try{document.dispatchEvent(new KeyboardEvent('keydown',{key:'Escape',code:'Escape',keyCode:27,which:27,bubbles:!0}));document.dispatchEvent(new KeyboardEvent('keyup',{key:'Escape',code:'Escape',keyCode:27,which:27,bubbles:!0}))}catch(e){}
return clicked}
function handleCloseTrailerIntent(lower){var closeIntent=/\bclose\b.*\btrailer\b/.test(lower)||/\bclose\b.*\bvideo\b/.test(lower)||/\bclose\b.*\bpopup\b/.test(lower)||/\bclose\b.*\bmodal\b/.test(lower)||/\btrailer\b.*\bband\b/.test(lower)||/\bclose this\b/.test(lower)||/\bclose it\b/.test(lower)||/\bclose\b/.test(lower)||/\bband karo\b/.test(lower)||/\bband krdo\b/.test(lower)||/\bband kar do\b/.test(lower);if(!closeIntent)return!1;var ok=closeOpenOverlays();addMessage('assistant',ok?'Trailer closed.':'Tried to close open trailer/popup.');return!0}
function tryPendingMoviesSearch(){var pending='';try{pending=localStorage.getItem('va_pending_movies_search')||''}catch(e){}
if(!pending)return;try{localStorage.removeItem('va_pending_movies_search')}catch(e){}
setTimeout(function(){var query=extractMoviesSearchQuery(pending,pending.toLowerCase());if(!runMoviesSearch(query)){addMessage('assistant','Movies page opened. Please say: "search avatar".')}},500)}
function handleDownloadIntent(raw,lower){var hasDownloadWord=lower.indexOf('download')!==-1||lower.indexOf('install')!==-1||lower.indexOf('get app')!==-1||lower.indexOf('apk')!==-1;if(!hasDownloadWord)return!1;var query=raw.replace(/download/ig,' ').replace(/install/ig,' ').replace(/get app/ig,' ').replace(/apk/ig,' ').replace(/please/ig,' ').replace(/\s+/g,' ').trim();if(!query){addMessage('assistant','App name bolo. Example: "download opplex app" or "download 9xtream".');return!0}
var found=findBestDownloadLink(query);if(found){triggerDownload(found);return!0}
requestDownloadOnAppsPage(query);return!0}
function setPending(action,prompt){pendingAction=action;addMessage('assistant',prompt+' Please confirm to proceed.')}
function isConfigurePage(){return!!document.getElementById('configForm')}
function isCheckoutPage(){return!!document.getElementById('checkoutForm')}
function clickElement(el){if(!el)return!1;el.click();el.scrollIntoView({behavior:'smooth',block:'center'});return!0}
function pickConfigDevice(lower){if(!isConfigurePage())return!1;var map=[{key:'android',aliases:['android']},{key:'firestick',aliases:['firestick','fire stick','amazon']},{key:'ios',aliases:['ios','iphone','ipad']},{key:'mag',aliases:['mag','mag box']},{key:'pcmac',aliases:['pc','mac','pc/mac','pc mac']},{key:'smarttv',aliases:['smart tv','smarttv','tv']}];var target=null;map.forEach(function(m){if(target)return;if(m.aliases.some(function(a){return lower.indexOf(a)!==-1})){target=m.key}});if(!target)return!1;var cards=Array.prototype.slice.call(document.querySelectorAll('#deviceSection [data-device]'));var found=cards.find(function(card){var text=normalizeText(card.getAttribute('data-device')||card.textContent||'');return text.indexOf(target)!==-1});if(!found&&target==='pcmac'){found=cards.find(function(card){var text=normalizeText(card.getAttribute('data-device')||card.textContent||'');return text.indexOf('pc')!==-1||text.indexOf('mac')!==-1})}
if(!found)return!1;clickElement(found);addMessage('assistant','Device selected.');return!0}
function pickConfigVendor(lower){if(!isConfigurePage())return!1;var vendor=null;if(lower.indexOf('opplex')!==-1)vendor='opplex';if(lower.indexOf('starshare')!==-1||lower.indexOf('star share')!==-1)vendor='starshare';if(!vendor)return!1;var cards=Array.prototype.slice.call(document.querySelectorAll('#vendorSection [data-vendor]'));var found=cards.find(function(card){return normalizeText(card.getAttribute('data-vendor')||'').indexOf(vendor)!==-1});if(!found)return!1;clickElement(found);addMessage('assistant','Provider selected: '+(vendor==='opplex'?'Opplex':'Starshare')+'.');return!0}
function pickConfigConnection(lower){if(!isConfigurePage())return!1;if(lower.indexOf('connection')===-1&&lower.indexOf('device 1')===-1&&lower.indexOf('device 2')===-1&&lower.indexOf('device 4')===-1){return!1}
var max=null;if(lower.indexOf('4')!==-1||lower.indexOf('four')!==-1)max='4';else if(lower.indexOf('2')!==-1||lower.indexOf('two')!==-1)max='2';else if(lower.indexOf('1')!==-1||lower.indexOf('one')!==-1||lower.indexOf('single')!==-1)max='1';if(!max)return!1;var cards=Array.prototype.slice.call(document.querySelectorAll('[data-kind="connection"]')).filter(function(c){return c.style.display!=='none'});var found=cards.find(function(card){return(card.getAttribute('data-max')||'')===max});if(!found){addMessage('assistant','This connection plan is not available for the current provider/package.');return!0}
clickElement(found);addMessage('assistant','Connection plan selected.');return!0}
function setPackageTabByIntent(lower){if(!isConfigurePage())return!1;var tab=null;if(lower.indexOf('reseller')!==-1)tab='reseller';if(lower.indexOf('iptv')!==-1)tab='iptv';if(!tab)return!1;var btn=document.querySelector('#pkgToggle .tg-btn[data-tab="'+tab+'"]');if(!btn)return!1;clickElement(btn);addMessage('assistant',(tab==='iptv'?'IPTV':'Reseller')+' packages opened.');return!0}
function pickConfigPackage(lower){if(!isConfigurePage())return!1;var targetKey=inferPackageKeyFromText(lower);if(!targetKey)return!1;if(['starter','essential','pro','advanced'].indexOf(targetKey)!==-1){var resellerTab=document.querySelector('#pkgToggle .tg-btn[data-tab="reseller"]');if(resellerTab&&!resellerTab.classList.contains('active'))resellerTab.click();}else{var iptvTab=document.querySelector('#pkgToggle .tg-btn[data-tab="iptv"]');if(iptvTab&&!iptvTab.classList.contains('active'))iptvTab.click();}
var found=selectPackageByKey(targetKey);if(!found){addMessage('assistant','Package not found for current filters.');return!0}
if(found.getAttribute('data-kind')==='iptv'){ensureVendorForIptvCard(found)}
clickElement(found);addMessage('assistant','Package selected.');return!0}
function pickConfigPackageByName(raw,lower){if(!isConfigurePage())return!1;var triggerWords=['select','choose','package','plan','pick'];var hasTrigger=triggerWords.some(function(w){return lower.indexOf(w)!==-1});var hasCommonPackageName=/\bmonthly\b|\b3\s*months?\b|\bhalf\s*year(ly)?\b|\byearly\b|\bstarter\b|\bessential\b|\bpro\b|\badvanced\b/.test(lower);if(!hasTrigger&&!hasCommonPackageName)return!1;var query=normalizeText(raw).replace(/\b(select|choose|package|plan|pick|please|karo|kar do|krdo|wala|wla)\b/g,' ').replace(/\s+/g,' ').trim();if(!query)return!1;if(query.indexOf('reseller')!==-1){var resellerTab=document.querySelector('#pkgToggle .tg-btn[data-tab="reseller"]');if(resellerTab&&!resellerTab.classList.contains('active'))resellerTab.click();}else if(query.indexOf('monthly')!==-1||query.indexOf('yearly')!==-1||query.indexOf('half yearly')!==-1||query.indexOf('3 months')!==-1){var iptvTab=document.querySelector('#pkgToggle .tg-btn[data-tab="iptv"]');if(iptvTab&&!iptvTab.classList.contains('active'))iptvTab.click();}
var directKey=inferPackageKeyFromText(query);if(directKey){var directFound=selectPackageByKey(directKey);if(directFound){if(directFound.getAttribute('data-kind')==='iptv')ensureVendorForIptvCard(directFound);clickElement(directFound);addMessage('assistant','Selected package: '+((directFound.getAttribute('data-plan')||'').trim()||'package')+'.');return!0}}
var cards=Array.prototype.slice.call(document.querySelectorAll('.pkg-card')).filter(function(c){return c.style.display!=='none'});if(!cards.length)return!1;var queryTokens=query.split(' ').filter(function(t){return t.length>1});var best=null;var bestScore=0;cards.forEach(function(card){var plan=normalizeText(card.getAttribute('data-plan')||card.textContent||'');var score=0;if(plan.indexOf(query)!==-1||query.indexOf(plan)!==-1)score+=6;if(plan===query)score+=20;if(query==='yearly'&&plan==='yearly')score+=15;if(query==='3 months'&&plan.indexOf('3 months')!==-1)score+=15;if(query==='half yearly'&&plan.indexOf('half yearly')!==-1)score+=15;if(query==='yearly'&&plan.indexOf('half yearly')!==-1)score-=8;queryTokens.forEach(function(t){if(plan.indexOf(t)!==-1)score+=2});if(score>bestScore){best=card;bestScore=score}});if(!best||bestScore<2)return!1;if(best.getAttribute('data-kind')==='iptv'){ensureVendorForIptvCard(best)}
clickElement(best);addMessage('assistant','Selected package: '+((best.getAttribute('data-plan')||'').trim()||'package')+'.');return!0}
function packageKeyFromPlanName(planText){var p=normalizeText(planText||'');if(!p)return'';if(/\b3\s*months?\b|\bthree\s*months?\b/.test(p))return'3months';if(/\bhalf\s*year(ly)?\b|\b6\s*months?\b/.test(p))return'halfyearly';if(/^yearly$|\byearly\b/.test(p)&&p.indexOf('half yearly')===-1)return'yearly';if(/\bmonthly\b|\b1\s*month\b/.test(p))return'monthly';if(/\bstarter\b|\b20\s*credits?\b/.test(p))return'starter';if(/\bessential\b|\b50\s*credits?\b/.test(p))return'essential';if(/\bpro\b|\b100\s*credits?\b/.test(p))return'pro';if(/\badvanced\b|\b200\s*credits?\b|\b300\s*credits?\b/.test(p))return'advanced';return''}
function inferPackageKeyFromText(text){var t=normalizeText(text||'');if(!t)return'';if(/\b3\s*months?\b|\bthree\s*months?\b|\bquarter\b/.test(t))return'3months';if(/\bhalf\s*year(ly)?\b|\b6\s*months?\b|\bsix\s*months?\b/.test(t))return'halfyearly';if(/\byearly\b|\bannual\b|\b12\s*months?\b|\b1\s*year\b|\bone\s*year\b/.test(t)&&t.indexOf('half yearly')===-1)return'yearly';if(/\bmonthly\b|\b1\s*month\b|\bone\s*month\b/.test(t))return'monthly';if(/\bstarter\b|\b20\s*credits?\b/.test(t))return'starter';if(/\bessential\b|\b50\s*credits?\b/.test(t))return'essential';if(/\bpro\b|\b100\s*credits?\b/.test(t))return'pro';if(/\badvanced\b|\b200\s*credits?\b|\b300\s*credits?\b/.test(t))return'advanced';return''}
function selectPackageByKey(key){if(!key)return null;var cards=Array.prototype.slice.call(document.querySelectorAll('.pkg-card')).filter(function(c){return c.style.display!=='none'});var exact=cards.find(function(card){var planKey=packageKeyFromPlanName(card.getAttribute('data-plan')||card.textContent||'');return planKey===key});return exact||null}
function ensureVendorForIptvCard(card){var vendorInput=document.getElementById('iptvVendorInput');if(!vendorInput||vendorInput.value)return;var cardVendor=normalizeText(card.getAttribute('data-vendor')||'');var vendorButtons=Array.prototype.slice.call(document.querySelectorAll('#vendorSection [data-vendor]'));var match=vendorButtons.find(function(btn){return normalizeText(btn.getAttribute('data-vendor')||'').indexOf(cardVendor)!==-1});if(!match)match=vendorButtons[0]||null;if(match)match.click();}
function continueFromConfigure(){if(!isConfigurePage())return!1;var btn=document.getElementById('continueBtn');if(!btn)return!1;if(btn.disabled){addMessage('assistant','Please select device, provider, connection, and package first.');return!0}
clickElement(btn);addMessage('assistant','Continuing to checkout.');return!0}
function hasPricingPackagesSection(){return!!document.getElementById('pricing-section')}
function isElementVisible(el){if(!el)return!1;if(el.offsetParent===null&&getComputedStyle(el).position!=='fixed')return!1;var st=getComputedStyle(el);return st.display!=='none'&&st.visibility!=='hidden'&&st.opacity!=='0'}
function isAssistantElement(el){return!!(el&&el.closest&&el.closest('#voice-assistant'))}
function clickableCandidates(){return Array.prototype.slice.call(document.querySelectorAll('a[href], button, [role="button"], input[type="button"], input[type="submit"]')).filter(function(el){if(!el)return!1;if(isAssistantElement(el))return!1;if(!isElementVisible(el))return!1;if(el.disabled)return!1;var href=(el.getAttribute('href')||'').trim();if(el.tagName&&el.tagName.toLowerCase()==='a'&&(!href||href==='#'))return!1;return!0})}
function clickableText(el){if(!el)return'';var txt=normalizeText(el.textContent||'');var aria=normalizeText(el.getAttribute('aria-label')||'');var title=normalizeText(el.getAttribute('title')||'');var value=normalizeText(el.value||'');var href=normalizeText((el.getAttribute('href')||'').replace(/^https?:\/\//i,''));return(txt+' '+aria+' '+title+' '+value+' '+href).trim()}
function extractClickQuery(raw,lower){var q=normalizeText(raw||'');q=q.replace(/\b(click|press|tap|open|go to|goto|select|choose|visit|trigger)\b/g,' ').replace(/\bbutton|link|menu|page\b/g,' ').replace(/\s+/g,' ').trim();return q||normalizeText(lower||'')}
function handleGenericClickByText(raw,lower){if(/\b(first name|last name|full name|email|phone|order note|notes)\b/.test(lower))return!1;var query=extractClickQuery(raw,lower);if(!query)return!1;var tokens=query.split(' ').filter(function(t){return t.length>1});if(!tokens.length)return!1;var candidates=clickableCandidates();if(!candidates.length)return!1;var best=null;var bestScore=0;candidates.forEach(function(el){var hay=clickableText(el);if(!hay)return;var score=0;if(hay===query)score+=20;if(hay.indexOf(query)!==-1)score+=10;tokens.forEach(function(t){if(hay.indexOf(t)!==-1)score+=2});if(score>bestScore){best=el;bestScore=score}});if(!best||bestScore<5)return!1;best.scrollIntoView({behavior:'smooth',block:'center'});best.click();addMessage('assistant','Clicked: '+((best.textContent||best.getAttribute('aria-label')||'target').trim().slice(0,60)));return!0}
function setPricingVendor(vendorKey){if(!hasPricingPackagesSection())return!1;var resellerToggle=document.getElementById('resellerToggle');var isReseller=!!(resellerToggle&&resellerToggle.checked);var toggle=document.getElementById(isReseller?'vendorToggleReseller':'vendorToggle');if(!toggle)return!1;var btn=toggle.querySelector('.tg[data-vendor="'+vendorKey+'"]');if(!btn)return!1;btn.click();addMessage('assistant','Vendor selected: '+(vendorKey==='opplex'?'Opplex':'Starshare')+'.');return!0}
function setPricingMode(showReseller){if(!hasPricingPackagesSection())return!1;var resellerToggle=document.getElementById('resellerToggle');if(!resellerToggle)return!1;if(resellerToggle.checked!==showReseller){resellerToggle.checked=showReseller;resellerToggle.dispatchEvent(new Event('change',{bubbles:!0}))}
addMessage('assistant',showReseller?'Reseller packages shown.':'IPTV packages shown.');return!0}
function visiblePricingCards(){return Array.prototype.slice.call(document.querySelectorAll('#pricing-section .pkg-item')).filter(isElementVisible)}
function pricingCardKey(card){var t=normalizeText(card?card.textContent:'');if(/\b3\s*months?\b/.test(t))return'3months';if(/\b6\s*months?\b|\bhalf\s*year(ly)?\b/.test(t))return'halfyearly';if(/\b12\s*months?\b|\byearly\b/.test(t))return'yearly';if(/\b1\s*month\b|\bmonthly\b/.test(t))return'monthly';if(/\bstarter\b|\b20\s*credits?\b/.test(t))return'starter';if(/\bessential\b|\b50\s*credits?\b/.test(t))return'essential';if(/\bpro\b|\b100\s*credits?\b/.test(t))return'pro';if(/\badvanced\b|\b200\s*credits?\b|\b300\s*credits?\b/.test(t))return'advanced';return''}
function pricingCardTitle(card){if(!card)return'';var h4=card.querySelector('h4');return normalizeText(h4?h4.textContent:card.textContent||'')}
function extractPricingQuery(raw){var q=normalizeText(raw||'');if(!q)return'';q=q.replace(/\bbuy now\b/g,' ').replace(/\bpricing\b/g,' ').replace(/\bpackage(s)?\b/g,' ').replace(/\bplan(s)?\b/g,' ').replace(/\bbuy\b/g,' ').replace(/\bselect\b/g,' ').replace(/\bchoose\b/g,' ').replace(/\bopen\b/g,' ').replace(/\bnow\b/g,' ').replace(/\bplease\b/g,' ').replace(/\bthis\b/g,' ').replace(/\bone\b/g,' ').replace(/\bplease\b/g,' ').replace(/\s+/g,' ').trim();return q}
function findPricingCardByQuery(query){var cards=visiblePricingCards();if(!cards.length)return null;if(!query)return null;var inferredKey=inferPackageKeyFromText(query);if(inferredKey){var byKey=cards.find(function(c){return pricingCardKey(c)===inferredKey})||null;if(byKey)return byKey}
var tokens=query.split(' ').filter(function(t){return t.length>1});if(!tokens.length)return null;var best=null;var bestScore=0;cards.forEach(function(card){var title=pricingCardTitle(card);var key=pricingCardKey(card);var score=0;if(title===query)score+=25;if(title.indexOf(query)!==-1)score+=10;if(key&&query.indexOf(key)!==-1)score+=6;if(key==='3months'&&/\b3\s*months?\b|\bthree\s*months?\b/.test(query))score+=12;if(key==='halfyearly'&&/\bhalf\s*year(ly)?\b|\b6\s*months?\b|\bsix\s*months?\b/.test(query))score+=12;if(key==='yearly'&&/\byearly\b|\b12\s*months?\b|\bannual\b|\bone\s*year\b/.test(query))score+=12;if(key==='monthly'&&/\bmonthly\b|\b1\s*month\b|\bone\s*month\b/.test(query))score+=12;tokens.forEach(function(t){if(title.indexOf(t)!==-1)score+=2});if(score>bestScore){best=card;bestScore=score}});return bestScore>=3?best:null}
function selectAndBuyPricingCardByKey(key,shouldBuy){var cards=visiblePricingCards();if(!cards.length)return!1;var card=cards.find(function(c){return pricingCardKey(c)===key})||null;if(!card)return!1;card.scrollIntoView({behavior:'smooth',block:'center'});if(!shouldBuy){addMessage('assistant','Package found: '+(card.querySelector('h4')?card.querySelector('h4').textContent.trim():'selected')+'.');return!0}
var buyBtn=card.querySelector('a.theme-btn.btn-style-four');if(!buyBtn)return!1;buyBtn.click();addMessage('assistant','Opening buy now.');return!0}
function selectAndBuyPricingCardByQuery(query,shouldBuy){var card=findPricingCardByQuery(query);if(!card)return!1;card.scrollIntoView({behavior:'smooth',block:'center'});if(!shouldBuy){addMessage('assistant','Package found: '+(card.querySelector('h4')?card.querySelector('h4').textContent.trim():'selected')+'.');return!0}
var buyBtn=card.querySelector('a.theme-btn.btn-style-four');if(!buyBtn)return!1;buyBtn.click();addMessage('assistant','Opening buy now.');return!0}
function handlePricingSectionIntent(raw,lower){if(!hasPricingPackagesSection()||isConfigurePage()||isCheckoutPage())return!1;if(/\bshow\b.*\breseller\b|\breseller\b.*\bshow\b|\breseller packages\b/.test(lower)){return setPricingMode(!0)}
if(/\bshow\b.*\biptv\b|\biptv\b.*\bshow\b|\bhide reseller\b|\bnormal packages\b/.test(lower)){return setPricingMode(!1)}
if(lower.indexOf('opplex')!==-1)return setPricingVendor('opplex');if(lower.indexOf('starshare')!==-1||lower.indexOf('star share')!==-1)return setPricingVendor('starshare');var key=inferPackageKeyFromText(lower);var wantsBuy=/\bbuy\b|\bbuy now\b|\bselect\b|\bchoose\b|\bopen\b/.test(lower);if(key){var ok=selectAndBuyPricingCardByKey(key,wantsBuy);if(ok)return!0}
var query=extractPricingQuery(raw);if(query){var okByQuery=selectAndBuyPricingCardByQuery(query,wantsBuy);if(okByQuery)return!0}
if(/\bbuy now\b|\bbuy\b/.test(lower)){if(query||key){addMessage('assistant','Package not found. Please say exact package name, like "buy 3 months package".');return!0}
var cards=visiblePricingCards();if(!cards.length)return!1;var firstBuy=cards[0].querySelector('a.theme-btn.btn-style-four');if(firstBuy){firstBuy.click();addMessage('assistant','Opening buy now.');return!0}}
return!1}
function hasShopProductsSection(){return!!document.querySelector('.product-grid, .product-card')}
function getShopProductCards(){return Array.prototype.slice.call(document.querySelectorAll('.product-card')).filter(isElementVisible)}
function extractShopQuery(raw,lower){var q=raw;q=q.replace(/\bbuy on amazon\b/ig,' ');q=q.replace(/\bbuy\b/ig,' ');q=q.replace(/\bon amazon\b/ig,' ');q=q.replace(/\bamazon\b/ig,' ');q=q.replace(/\bplease\b/ig,' ');q=q.replace(/\s+/g,' ').trim();if(!q)return'';return normalizeText(q)}
function shopCardText(card){if(!card)return'';var title=normalizeText((card.querySelector('.product-card__title')||{}).textContent||'');var meta=normalizeText((card.querySelector('.product-card__meta')||{}).textContent||'');var aria=normalizeText(card.getAttribute('aria-label')||'');return(title+' '+meta+' '+aria).trim()}
function findBestShopCard(query){var cards=getShopProductCards();if(!cards.length)return null;if(!query)return cards[0];var tokens=query.split(' ').filter(function(t){return t.length>1});if(!tokens.length)return cards[0];var best=null;var bestScore=0;cards.forEach(function(card){var hay=shopCardText(card);var score=0;if(hay.indexOf(query)!==-1)score+=8;tokens.forEach(function(t){if(hay.indexOf(t)!==-1)score+=2});var asinLike=query.match(/\b[a-z0-9]{8,12}\b/i);if(asinLike&&hay.indexOf(normalizeText(asinLike[0]))!==-1)score+=10;if(score>bestScore){best=card;bestScore=score}});return bestScore>0?best:null}
function clickShopBuy(card){if(!card)return!1;var btn=card.querySelector('a.product-card__btn');if(!btn)return!1;btn.click();addMessage('assistant','Opening Amazon product.');return!0}
function handleShopBuyIntent(raw,lower){var buyIntent=/\bbuy\b|\bbuy on amazon\b|\bon amazon\b|\bamazon\b/.test(lower);var hasAmazonIntent=/\bamazon\b|\bbuy on amazon\b|\bon amazon\b/.test(lower);var maybeProductHint=/\bremote\b|\broku\b|\bfire\b|\bsamsung\b|\bvizio\b|\bstick\b|\basin\b|\bpack\b|\btv\b/.test(lower);if(!(hasAmazonIntent||(buyIntent&&maybeProductHint)))return!1;if(!hasShopProductsSection()){requestShopActionOnShopPage(raw);return!0}
var query=extractShopQuery(raw,lower);var card=findBestShopCard(query);if(!card){addMessage('assistant','Product not found. Please say a clearer hint or ASIN.');return!0}
card.scrollIntoView({behavior:'smooth',block:'center'});return clickShopBuy(card)}
function isDirectPricingBuyPackageIntent(lower){var hasBuy=/\bbuy\b|\bbuy now\b/.test(lower);var hasPackageKey=!!inferPackageKeyFromText(lower);var hasPricingWord=/\bpricing\b|\bplan(s)?\b|\bpackage(s)?\b/.test(lower);return hasBuy&&hasPackageKey&&hasPricingWord}
function shouldRouteToPricingForBuy(raw,lower){if(hasPricingPackagesSection())return!1;if(isConfigurePage()||isCheckoutPage())return!1;var mentionsPricing=/\bpricing\b|\bplans?\b|\bpackages?\b/.test(lower);var wantsBuy=/\bbuy\b|\bbuy now\b|\bselect\b|\bchoose\b/.test(lower);return mentionsPricing&&wantsBuy}
function setCheckoutType(lower){if(!isCheckoutPage())return!1;if(lower.indexOf('package type')===-1&&lower.indexOf('reseller type')===-1&&lower.indexOf('iptv type')===-1&&lower.indexOf('iptv package')===-1&&lower.indexOf('reseller package')===-1)return!1;var select=document.querySelector('#checkoutForm select[name="package_type"]');if(!select)return!1;if(lower.indexOf('reseller')!==-1)select.value='reseller';else if(lower.indexOf('iptv')!==-1||lower.indexOf('package')!==-1)select.value='package';else return!1;select.dispatchEvent(new Event('change',{bubbles:!0}));addMessage('assistant','Checkout type updated.');return!0}
function setPaymentMethod(lower){if(!isCheckoutPage())return!1;if(lower.indexOf('payment')===-1&&lower.indexOf('pay')===-1&&lower.indexOf('card')===-1&&lower.indexOf('crypto')===-1)return!1;var targetValue=null;if(lower.indexOf('crypto')!==-1||lower.indexOf('usdt')!==-1||lower.indexOf('bitcoin')!==-1)targetValue='crypto';if(lower.indexOf('card')!==-1||lower.indexOf('visa')!==-1||lower.indexOf('master')!==-1)targetValue='card';if(!targetValue)return!1;var radio=document.querySelector('input[name="paymethod"][value="'+targetValue+'"]');if(!radio)return!1;radio.checked=!0;radio.dispatchEvent(new Event('change',{bubbles:!0}));addMessage('assistant','Payment method selected: '+targetValue+'.');return!0}
function setCheckoutFormFields(raw,lower){if(!isCheckoutPage())return!1;var changed=!1;var textNorm=normalizeText(raw);var parseSpokenEmail=function(source){var s=String(source||'');var explicit=s.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);if(explicit)return explicit[0];var tail=s.replace(/.*(?:my\s+)?email(?:\s+address)?\s*(?:is|=|:)?/i,'').trim();if(!tail)return'';var e=tail.toLowerCase().replace(/\bat\s+the\s+rate\b/g,'@').replace(/\bat[-\s]?rate\b/g,'@').replace(/\battherate\b/g,'@').replace(/\s*\(at\)\s*/g,'@').replace(/\s+at\s+/g,'@').replace(/\s*\(dot\)\s*/g,'.').replace(/\s+dot\s+/g,'.').replace(/\s+underscore\s+/g,'_').replace(/\s+dash\s+/g,'-').replace(/\s+plus\s+/g,'+').replace(/\s+/g,'').replace(/[,;]+$/g,'').replace(/[^a-z0-9@._+\-]/g,'');e=e.replace(/(thanks|thankyou|ok|okay|please).*$/i,'');return e};var emailMatch=raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);var emailIntent=lower.indexOf('email')!==-1||!!emailMatch;if(emailIntent){var parsedEmail=parseSpokenEmail(raw);if(parsedEmail&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(parsedEmail)){changed=setFieldValue('email',parsedEmail)||changed;memory.email=parsedEmail}else{addMessage('assistant','Email samajh nahi aaya. Example bolo: "email is ameeq at gmail dot com".');return!0}}
var extractFieldValue=function(source,pattern,stopWordsRegex){var m=source.match(pattern);if(!m||!m[1])return'';var value=m[1].trim();if(!value)return'';value=value.replace(stopWordsRegex,'').trim();return value.split(/\s+/)[0]||''};var lastValue=extractFieldValue(textNorm,/(?:^|\b)(?:last\s*name|lname|surname)\s*(?:is|=|:)?\s*([a-z][a-z\s'-]*)/i,/\b(first\s*name|fname|email|phone|mobile|note|order)\b.*$/i);if(lastValue){changed=setFieldValue('last_name',lastValue)||changed;memory.lastName=lastValue}
var firstValue=extractFieldValue(textNorm,/(?:^|\b)(?:first\s*name|fname)\s*(?:is|=|:)?\s*([a-z][a-z\s'-]*)/i,/\b(last\s*name|lname|surname|email|phone|mobile|note|order)\b.*$/i);if(firstValue){changed=setFieldValue('first_name',firstValue)||changed;memory.firstName=firstValue}
if(!firstValue&&!lastValue&&(lower.indexOf('full name')!==-1||lower.indexOf('my full name')!==-1)){var full=raw.replace(/.*(my full name|full name)\s*(is|=|:)?/i,'').trim();if(full){var parts=parseName(full);changed=setFieldValue('first_name',parts.first)||changed;if(parts.last)changed=setFieldValue('last_name',parts.last)||changed;memory.firstName=parts.first;memory.lastName=parts.last;memory.fullName=full}}
var cleanedDigits=raw.replace(/[^0-9+]/g,'');var phoneIntent=lower.indexOf('phone')!==-1||lower.indexOf('mobile')!==-1||lower.indexOf('whatsapp number')!==-1;if(phoneIntent&&cleanedDigits.length>=7){changed=setFieldValue('phone',cleanedDigits)||changed;memory.phone=cleanedDigits}
if(lower.indexOf('order note')!==-1||lower.indexOf('notes')!==-1||lower.indexOf('note')!==-1){var note=raw.replace(/.*(order note|notes|note)\s*(is|=|:)?/i,'').trim();if(note){changed=setFieldValue('notes',note)||changed;memory.notes=note}}
if(changed){addMessage('assistant','Checkout details updated.');return!0}
return!1}
function submitCheckoutOrder(){var form=document.getElementById('checkoutForm');if(!form)return!1;var requiredFields=['email','first_name','last_name','phone'];var missing=requiredFields.filter(function(name){var field=form.querySelector('[name="'+name+'"]');return!field||!String(field.value||'').trim()});if(missing.length){addMessage('assistant','Please complete required fields first: email, first name, last name, and phone.');return!0}
var emailField=form.querySelector('[name="email"]');var emailVal=emailField?String(emailField.value||'').trim():'';if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal)){addMessage('assistant','Please enter a valid email address.');return!0}
if(typeof form.requestSubmit==='function'){form.requestSubmit()}else{var submitBtn=document.querySelector('button[form="checkoutForm"][type="submit"], #checkoutForm button[type="submit"], .place-order[form="checkoutForm"]');if(submitBtn)submitBtn.click();else form.submit()}
addMessage('assistant','Placing your order now.');return!0}
function isPlaceOrderIntent(lower){return/\bplace\s*order(?:\s*(?:&|and)\s*pay)?\b|\bsubmit\s*order\b|\bbuy\s*now\b/.test(lower)}
function clickPlaceOrderButton(){var candidates=Array.prototype.slice.call(document.querySelectorAll('.place-order, button[form="checkoutForm"], #checkoutForm button[type="submit"]'));var btn=candidates.find(function(el){var txt=normalizeText(el.textContent||'');return txt.indexOf('place order')!==-1||txt.indexOf('pay')!==-1})||candidates[0];if(!btn)return!1;btn.click();addMessage('assistant','Placing your order now.');return!0}
function confirmIfPending(text){var confirmWords=['yes','confirm','ok','okay','sure','haan','ha','jee','theek','thik','s?','si','oui','da','sim','ja','hai','\u0646\u0639\u0645','\u062c\u06cc','\u06c1\u0627\u06ba'];var lower=canonicalizeMultilingualInput(text).toLowerCase();var confirmed=confirmWords.some(function(w){return lower.indexOf(w)!==-1});if(confirmed&&pendingAction){var action=pendingAction;pendingAction=null;action();return!0}
return!1}
function handleIntent(text){var rawOriginal=(text||'').trim();if(!rawOriginal)return;var raw=canonicalizeMultilingualInput(rawOriginal);addMessage('user',rawOriginal);if(confirmIfPending(raw))return;var lower=normalizeIntentLower(raw.toLowerCase());if(handleOpenTrailerByName(raw,lower))return;if(handleCloseTrailerIntent(lower))return;if(handleMoviesSearchIntent(raw,lower))return;if(isDirectPricingBuyPackageIntent(lower)){if(hasPricingPackagesSection()){if(handlePricingSectionIntent(raw,lower))return}else{requestPricingActionOnPricingPage(raw);return}}
if(shouldRouteToPricingForBuy(raw,lower)){requestPricingActionOnPricingPage(raw);return}
if(handlePricingSectionIntent(raw,lower))return;if(handleShopBuyIntent(raw,lower))return;if(isPlaceOrderIntent(lower)){if(isCheckoutPage()&&clickPlaceOrderButton())return;if(submitCheckoutOrder())return}
if(pickConfigDevice(lower))return;if(pickConfigVendor(lower))return;if(setPackageTabByIntent(lower))return;if(pickConfigConnection(lower))return;if(pickConfigPackageByName(raw,lower))return;if(pickConfigPackage(lower))return;if(setCheckoutFormFields(raw,lower))return;if(setCheckoutType(lower))return;if(setPaymentMethod(lower))return;if(handleGenericClickByText(raw,lower))return;var checkoutKeywords=['first name','last name','full name','email','phone','mobile','whatsapp','package type','payment','card','crypto','note'];var looksCheckoutCommand=checkoutKeywords.some(function(k){return lower.indexOf(k)!==-1});if(isCheckoutPage()&&looksCheckoutCommand){addMessage('assistant','Use clear commands like: "first name Ali", "last name Khan", "email ali@gmail.com", "phone 923001234567", "pay with card", "place order and pay".');return}
if(lower.indexOf('continue checkout')!==-1||lower.indexOf('continue to checkout')!==-1||lower.indexOf('next step')!==-1){if(continueFromConfigure())return;return openRoute('checkout','checkout')}
if(handleDownloadIntent(raw,lower))return;if(lower.indexOf('help')!==-1||lower.indexOf('kya kar')!==-1){addMessage('assistant','I can open pages, guide checkout, and fill forms. Try: "open pricing", "checkout", "contact".');return}
if(lower.indexOf('open')!==-1||lower.indexOf('go to')!==-1||lower.indexOf('show')!==-1||lower.indexOf('visit')!==-1){if(lower.indexOf('pricing')!==-1||lower.indexOf('price')!==-1)return openRoute('pricing','pricing');if(lower.indexOf('package')!==-1)return openRoute('packages','packages');if(lower.indexOf('reseller')!==-1)return openRoute('reseller','reseller panel');if(lower.indexOf('app')!==-1||lower.indexOf('application')!==-1)return openRoute('apps','IPTV applications');if(lower.indexOf('movie')!==-1||lower.indexOf('vod')!==-1||lower.indexOf('series')!==-1)return openRoute('movies','movies');if(lower.indexOf('shop')!==-1||lower.indexOf('device')!==-1)return openRoute('shop','shop');if(lower.indexOf('blog')!==-1)return openRoute('blogs','blogs');if(lower.indexOf('faq')!==-1)return openRoute('faqs','FAQs');if(lower.indexOf('contact')!==-1||lower.indexOf('support')!==-1)return openRoute('contact','contact');if(lower.indexOf('about')!==-1)return openRoute('about','about');if(lower.indexOf('home')!==-1)return openRoute('home','home');if(lower.indexOf('activate')!==-1)return openRoute('activate','activate');if(lower.indexOf('configure')!==-1)return openRoute('configure','configure');if(lower.indexOf('checkout')!==-1||lower.indexOf('pay')!==-1||lower.indexOf('order')!==-1){return openRoute('checkout','checkout')}}
if(lower.indexOf('checkout')!==-1||lower.indexOf('pay')!==-1||lower.indexOf('order')!==-1){if(continueFromConfigure())return;setPending(function(){var form=document.getElementById('checkoutForm');if(form){form.submit();addMessage('assistant','Submitting your checkout now.')}else{openRoute('checkout','checkout')}},'I can proceed with checkout.');return}
if(lower.indexOf('send message')!==-1||lower.indexOf('submit')!==-1){setPending(function(){var form=document.getElementById('contact-form');if(form){form.submit();addMessage('assistant','Sending your message.')}else{addMessage('assistant','I could not find the contact form on this page.')}},'I can submit the form.');return}
if(!isCheckoutPage()&&(lower.indexOf('my name is')!==-1||lower.indexOf('mera naam')!==-1||lower.indexOf('name is')!==-1)){var nameText=raw.replace(/.*(my name is|name is|mera naam)/i,'').trim();if(nameText){memory.fullName=nameText;var parts=parseName(nameText);memory.firstName=parts.first;memory.lastName=parts.last;fillContactForm();fillCheckoutForm();addMessage('assistant','Got it. I saved your name.');return}}
if(!isCheckoutPage()&&lower.indexOf('email')!==-1&&raw.indexOf('@')!==-1){var email=raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);if(email){memory.email=email[0];fillContactForm();fillCheckoutForm();addMessage('assistant','Email saved.');return}}
if(!isCheckoutPage()&&(lower.indexOf('phone')!==-1||lower.indexOf('mobile')!==-1)){var phone=raw.replace(/[^0-9+]/g,'');if(phone.length>=7){memory.phone=phone;fillContactForm();fillCheckoutForm();addMessage('assistant','Phone number saved.');return}}
if(!isCheckoutPage()&&(lower.indexOf('message')!==-1||lower.indexOf('note')!==-1)){var msg=raw.replace(/.*(message|note)/i,'').trim();if(msg){memory.message=msg;memory.notes=msg;fillContactForm();fillCheckoutForm();addMessage('assistant','Message saved.');return}}
if(lower.indexOf('terms')!==-1)return openRoute('terms','terms of service');if(lower.indexOf('privacy')!==-1)return openRoute('privacy','privacy policy');if(lower.indexOf('refund')!==-1)return openRoute('refund','refund policy');addMessage('assistant','I can help open pages or fill forms. Try: "open pricing", "checkout", or "contact".')}
sendBtn.addEventListener('click',function(){handleIntent(input.value);input.value=''});input.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();sendBtn.click()}});var SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;var recognizer=null;var micEnabled=isContinuousListeningEnabled();function startListening(){if(!recognizer||listening)return;try{listening=!0;micBtn.classList.add('listening');recognizer.start()}catch(e){listening=!1;if(!micEnabled)micBtn.classList.remove('listening');}}
function stopListening(){if(!recognizer)return;micEnabled=!1;setContinuousListening(!1);try{recognizer.stop()}catch(e){}
listening=!1;micBtn.classList.remove('listening')}
if(SpeechRecognition){recognizer=new SpeechRecognition();var speechLangMap={ar:'ar-SA',ur:'ur-PK',en:'en-US',es:'es-ES',fr:'fr-FR',hi:'hi-IN',it:'it-IT',nl:'nl-NL',pt:'pt-BR',ru:'ru-RU'};recognizer.lang=speechLangMap[LOCALE_BASE]||(document.documentElement.lang||'en-US');recognizer.continuous=!0;recognizer.interimResults=!1;recognizer.onstart=function(){listening=!0;if(micEnabled)micBtn.classList.add('listening');};recognizer.onresult=function(event){var result=event.results[event.resultIndex]&&event.results[event.resultIndex][0]?event.results[event.resultIndex][0]:null;if(!result)return;var transcript=result.transcript||'';var confidence=result.confidence;var cleanTranscript=String(transcript||'').trim();if(!cleanTranscript)return;if(isSpeaking)return;if(Date.now()<speakMuteUntil)return;if(cleanTranscript===lastHandledTranscript&&(Date.now()-lastHandledAt)<2500)return;lastHandledTranscript=cleanTranscript;lastHandledAt=Date.now();if(isContinuousListeningEnabled()){if(typeof confidence==='number'&&confidence>0&&confidence<0.45)return;if(cleanTranscript.length<4)return}
handleIntent(cleanTranscript)};recognizer.onend=function(){listening=!1;if(!micEnabled)micBtn.classList.remove('listening');if(micEnabled&&isContinuousListeningEnabled()&&!isCheckoutCompletePage()){micBtn.classList.add('listening');setTimeout(function(){startListening()},300)}};recognizer.onerror=function(event){var code=event&&event.error?String(event.error):'';listening=!1;if(code==='not-allowed'||code==='service-not-allowed'){micEnabled=!1;setContinuousListening(!1);micBtn.classList.remove('listening');return}
if(micEnabled&&isContinuousListeningEnabled()&&!isCheckoutCompletePage()){micBtn.classList.add('listening');setTimeout(function(){startListening()},450)}}}else{micBtn.disabled=!0;micBtn.title='Voice input not supported in this browser.'}
micBtn.addEventListener('click',function(){if(!recognizer)return;if(micEnabled){stopListening();return}
micEnabled=!0;setContinuousListening(!0);micBtn.classList.add('listening');startListening()});tryPendingDownload();tryPendingPricingAction();tryPendingShopAction();tryPendingMoviesSearch();initOnboardingGuide();try{localStorage.removeItem(LEGACY_LISTEN_KEY)}catch(e){}
voiceEnabled=getVoiceEnabledState();speakToggle.setAttribute('aria-pressed',voiceEnabled?'true':'false');speakToggle.textContent=voiceEnabled?VOICE_ON_TEXT:VOICE_OFF_TEXT;if(isCheckoutCompletePage()){stopListening()}else if(isContinuousListeningEnabled()&&recognizer){micEnabled=!0;openPanel();micBtn.classList.add('listening');startListening()}})()